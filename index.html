<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰¾å°çš„äºº (V7.0 åˆç›¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ html2canvas å‡½å¼åº«ï¼Œç”¨æ–¼å°‡çµæœè½‰æ›ç‚ºåœ–ç‰‡ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #111827; color: white; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .stroke-input { width: 40px; text-align: center; background: rgba(0,0,0,0.6); color: #fbbf24; border: 1px solid #4b5563; border-radius: 6px; font-weight: bold; }
        .char-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: inline-block; }
        .tag-simp { background: #ef4444; color: white; }
        .tag-trad { background: #10b981; color: white; }
        .tag-ext { background: #8b5cf6; color: white; box-shadow: 0 0 8px #8b5cf6; } 
        .tag-unknown { background: #6b7280; color: white; }
        
        /* æª”æ¡ˆä¸Šå‚³éš±è— */
        #fileInput { display: none; }
        .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* çˆ­è­°å­—å½©è™¹é–ƒçˆç‰¹æ•ˆ */
        .tag-rainbow { 
            background: linear-gradient(90deg, #ff0000, #ff7f00, #00b300, #0000ff, #8b00ff, #ff0000);
            background-size: 200% 200%;
            animation: rainbowBg 2s linear infinite;
            color: white; 
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
        }
        .rainbow-flash { animation: rainbowBorder 1.5s linear infinite; }
        @keyframes rainbowBg { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
        @keyframes rainbowBorder {
            0% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
            16% { border-color: #ff7f00; box-shadow: 0 0 10px #ff7f00; }
            33% { border-color: #ffff00; box-shadow: 0 0 10px #ffff00; }
            50% { border-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
            66% { border-color: #0000ff; box-shadow: 0 0 10px #0000ff; }
            83% { border-color: #8b00ff; box-shadow: 0 0 10px #8b00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        }

        /* çµæœå¡ç‰‡æ¨£å¼ */
        .result-card { border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .result-noble-direct { background: rgba(234,179,8,0.15); border: 1px solid rgba(234,179,8,0.4); }
        .result-noble-indirect { background: rgba(168,85,247,0.15); border: 1px solid rgba(168,85,247,0.4); }
        .result-villain-direct { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); }
        .result-villain-indirect { background: rgba(249,115,22,0.15); border: 1px solid rgba(249,115,22,0.4); }
        .result-equality { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.4); }
        .result-polarity { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.4); }
        .result-none { background: rgba(107,114,128,0.15); border: 1px solid rgba(107,114,128,0.4); }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <header class="w-full max-w-md flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-600 tracking-wider">æ‰¾å°çš„äºº</h1>
            <div class="text-xs text-purple-400 font-bold tracking-widest mt-1">V7.0 åˆç›¤ç‰ˆ</div>
        </div>
        <div class="flex items-center gap-2">
            <span id="dbCount" class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 font-mono">å…§å»º: 6000å­—</span>
            <button onclick="document.getElementById('fileInput').click()" id="importBtn" class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1.5 rounded-lg shadow-lg transition flex items-center gap-1">
                <span>ğŸ“‚</span> <span id="btnText">åŒ¯å…¥8è¬å­—åº«</span>
            </button>
            <input type="file" id="fileInput" accept=".json" onchange="loadExternalDB(this)">
        </div>
    </header>

    <!-- 1. æˆ‘æ˜¯èª° (User A) -->
    <div class="glass w-full max-w-md p-5 mb-4 relative border-l-4 border-yellow-500">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-yellow-400 text-lg flex items-center">ğŸ˜ æˆ‘æ˜¯èª° (A)</h3>
            <label class="text-xs text-gray-300 flex items-center cursor-pointer select-none" title="è‹¥ç‚ºæ­é™½ã€å¸é¦¬ç­‰è¤‡å§“è«‹å‹¾é¸">
                <input type="checkbox" id="uDouble" class="mr-1 w-4 h-4 accent-yellow-500 rounded"> è¤‡å§“ (å‰å…©å­—ç‚ºå§“)
            </label>
        </div>
        <div class="relative mb-4">
            <input type="text" id="uName" placeholder="æ¸¬è©¦è¼¸å…¥ï¼šæ­é™½è²è² æˆ– è•­è‚²æ²›" 
                   class="w-full p-3 rounded-xl bg-gray-900/50 border border-gray-600 text-white font-bold text-center text-xl focus:border-yellow-500 focus:outline-none transition-colors"
                   oninput="autoDetect('u')">
        </div>
        
        <!-- å‹•æ…‹ç­†åŠƒå€ -->
        <div class="bg-gray-900/40 p-3 rounded-xl">
            <div class="flex justify-center gap-3 flex-wrap" id="uStrokesArea"></div>
        </div>
        
        <!-- äº”æ ¼é è¦½ + é™°é™½ç›¤ -->
        <div class="mt-3 flex justify-between text-sm text-gray-300 px-2">
            <div>å¤©<span id="uTian" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>äºº<span id="uRen" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>åœ°<span id="uDi" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>å¤–<span id="uWai" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>ç¸½<span id="uZong" class="text-yellow-400 font-bold ml-1">?</span></div>
        </div>
        <div id="uPolarity" class="mt-2 text-center text-xs text-gray-500"></div>
    </div>

    <!-- 2. å°æ–¹æ˜¯ (User B) -->
    <div class="glass w-full max-w-md p-5 mb-8 relative border-l-4 border-blue-500">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-blue-400 text-lg flex items-center">ğŸ¯ å°æ–¹æ˜¯ (B)</h3>
            <label class="text-xs text-gray-300 flex items-center cursor-pointer select-none" title="è‹¥ç‚ºæ­é™½ã€å¸é¦¬ç­‰è¤‡å§“è«‹å‹¾é¸">
                <input type="checkbox" id="tDouble" class="mr-1 w-4 h-4 accent-blue-500 rounded"> è¤‡å§“ (å‰å…©å­—ç‚ºå§“)
            </label>
        </div>
        <div class="relative mb-4">
            <input type="text" id="tName" placeholder="è¼¸å…¥å§“å (æ”¯æ´ç°¡ç¹)" 
                   class="w-full p-3 rounded-xl bg-gray-900/50 border border-gray-600 text-white font-bold text-center text-xl focus:border-blue-500 focus:outline-none transition-colors"
                   oninput="autoDetect('t')">
        </div>

        <div class="bg-gray-900/40 p-3 rounded-xl">
            <div class="flex justify-center gap-3 flex-wrap" id="tStrokesArea"></div>
        </div>

        <!-- äº”æ ¼é è¦½ + é™°é™½ç›¤ -->
        <div class="mt-3 flex justify-between text-sm text-gray-300 px-2">
            <div>å¤©<span id="tTian" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>äºº<span id="tRen" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>åœ°<span id="tDi" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>å¤–<span id="tWai" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>ç¸½<span id="tZong" class="text-blue-400 font-bold ml-1">?</span></div>
        </div>
        <div id="tPolarity" class="mt-2 text-center text-xs text-gray-500"></div>
    </div>

    <!-- æŒ‰éˆ• -->
    <button onclick="calculateAndScan()" class="w-full max-w-md bg-gradient-to-r from-yellow-600 via-orange-600 to-red-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:shadow-yellow-500/20 active:scale-95 transition-all mb-8 flex justify-center items-center gap-2">
        <span>ğŸ”</span> å•Ÿå‹•åˆç›¤é‘‘å®š
    </button>

    <!-- çµæœå€ -->
    <div id="resultArea" class="hidden w-full max-w-md animate-fade-in-up"></div>
    
    <!-- éš±è—çš„åˆ†äº«ç”¨ç•«å¸ƒ (Canvas) -->
    <div id="shareCanvasArea" class="hidden"></div>

    <script>
        // ==========================================
        //  è³‡æ–™åº«ç³»çµ±
        // ==========================================
        let externalDB = {}; 
        let dbLoaded = false;

        // æ ¸å¿ƒå­—åº« (é è¨­ç²¾ç°¡ç‰ˆæ¼”ç¤º)
        const coreDB = {
            'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10,
            'é™³':16, 'æ—':8, 'é»ƒ':12, 'å¼µ':11, 'æ':7, 'ç‹':4, 'å³':7, 'åŠ‰':15, 'è”¡':17, 'æ¥Š':13,
            'è¨±':11, 'é„­':19, 'éƒ­':15, 'æ´ª':10, 'æ›¾':12, 'é‚±':12, 'å»–':14, 'å¾':10,
            'å¤§':3, 'å°':3, 'å¤©':4, 'æ–‡':4, 'æ­£':5, 'æ°¸':5, 'å¿—':7, 'å®':7, 'å›':7, 'æ˜':8,
            'æ€¡':9, 'ä¿Š':9, 'å»º':9, 'ç¾':9, 'å®¶':10, 'æ·‘':12, 'å©·':12, 'è¯':14, 'è±ª':14, 'éŠ˜':14,
            'æ­':15, 'é™½':17, 'å¸':5, 'é¦¬':10, 'è«¸':16, 'è‘›':15, 'è²':14, 'ç‚':8, 'ç›¸':9, 'å¦‚':6,
            'ç‹':5, 'ç‰':5, 'æ°µ':4, 'æ°´':4, 'å¿„':4, 'å¿ƒ':4, 'æ‰Œ':4, 'æ‰‹':4, 'è‰¹':6, 'è‰¸':6, 
            'æœˆ':6, 'è‚‰':6, 'è¾¶':7, 'è¾µ':7, 'é˜':8 
        };

        // ç°¡é«”å­—åº«
        const simpMap = {
            'é™ˆ': [16, 'é™³'], 'å¼ ': [11, 'å¼µ'], 'åˆ˜': [15, 'åŠ‰'], 'é»„': [12, 'é»ƒ'], 'æ¨': [13, 'æ¥Š'],
            'èµµ': [14, 'è¶™'], 'å‘¨': [8, 'å‘¨'], 'å´': [7, 'å³'], 'å¾': [10, 'å¾'], 'å­™': [10, 'å­«'],
            'é©¬': [10, 'é¦¬'], 'æœ±': [6, 'æœ±'], 'èƒ¡': [11, 'èƒ¡'], 'éƒ­': [15, 'éƒ­'], 'æ—': [8, 'æ—'],
            'é¾™': [16, 'é¾'], 'å': [14, 'è¯'], 'å›½': [11, 'åœ‹'], 'å¼º': [11, 'å¼·'], 'ä¼Ÿ': [11, 'å‰']
        };

        // çˆ­è­°å­—åº« (å„ªå…ˆæ””æˆª + å½©è™¹ç‰¹æ•ˆ)
        const dualStrokesMap = {
            'è‚²': [9, 10], 'å‰': [5, 6], 'å¦': [8, 9], 'å±': [10, 11],
            'æ¯“': [13, 14], 'æ²›': [8, 9], 'æ…ˆ': [13, 14], 'è•­': [18, 19]
        };

        // --- æª”æ¡ˆè¼‰å…¥é‚è¼¯ (æ”¯æ´ 8.1 è¬å­— kangxi_complete.json) ---
        function loadExternalDB(input) {
            const file = input.files[0];
            if (!file) return;

            const btnText = document.getElementById('btnText');
            const originalText = btnText.innerText;
            btnText.innerText = "è§£æä¸­...";
            document.getElementById('importBtn').classList.add('loading-pulse');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    let loadedCount = 0;
                    externalDB = {}; 
                    
                    let dataArray = null;
                    if (Array.isArray(json)) dataArray = json;
                    else if (json.data && Array.isArray(json.data)) dataArray = json.data;
                    else if (json.characters && Array.isArray(json.characters)) dataArray = json.characters;
                    else {
                        for (let key in json) {
                            if (Array.isArray(json[key]) && json[key].length > 1000) {
                                dataArray = json[key]; break;
                            }
                        }
                    }

                    if (dataArray) {
                        dataArray.forEach(item => {
                            if (item.character && item.strokes !== undefined) {
                                externalDB[item.character] = parseInt(item.strokes);
                                loadedCount++;
                            }
                        });
                    }
                    
                    // ä¹Ÿæ”¯æ´ç²¾ç°¡æ ¼å¼ { "å­—": ç­†åŠƒ }
                    if (!dataArray || loadedCount === 0) {
                        for (let ch in json) {
                            if (typeof json[ch] === 'number' && ch.length === 1) {
                                externalDB[ch] = json[ch];
                                loadedCount++;
                            }
                        }
                    }

                    if (loadedCount > 0) {
                        const countStr = loadedCount > 10000 ? (loadedCount/10000).toFixed(1) + "è¬" : loadedCount;
                        document.getElementById('dbCount').innerText = `æ»¿è¡€ç‰ˆ: ${countStr}å­—`;
                        document.getElementById('dbCount').classList.add('text-purple-400');
                        btnText.innerText = "å­—åº«å·²è¼‰å…¥";
                        document.getElementById('importBtn').classList.remove('bg-purple-600', 'loading-pulse');
                        document.getElementById('importBtn').classList.add('bg-green-600');
                        
                        autoDetect('u'); autoDetect('t');
                        alert(`âœ… è®€å–æˆåŠŸï¼å·²å°‡ ${loadedCount.toLocaleString()} å€‹åº·ç†™å­—å…¸è³‡æ–™åŒ¯å…¥è¨˜æ†¶é«”ã€‚`);
                    } else {
                        throw new Error("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„æ–‡å­—èˆ‡ç­†åŠƒé™£åˆ—");
                    }
                } catch (err) {
                    btnText.innerText = originalText;
                    document.getElementById('importBtn').classList.remove('loading-pulse');
                    alert("âŒ è®€å–å¤±æ•—: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- æŸ¥è©¢é‚è¼¯ ---
        function getCharInfo(char) {
            if (dualStrokesMap[char]) return { strokes: dualStrokesMap[char][0], origin: char, type: 'dual', alt: dualStrokesMap[char][1] };
            if (externalDB[char]) return { strokes: externalDB[char], origin: char, type: 'ext' };
            if (simpMap[char]) return { strokes: simpMap[char][0], origin: simpMap[char][1], type: 'simp' };
            if (coreDB[char]) return { strokes: coreDB[char], origin: char, type: 'trad' };
            return { strokes: 0, origin: char, type: 'unknown' };
        }

        // --- UI é‹ç®—èˆ‡æ¸²æŸ“ ---
        function autoDetect(prefix) {
            const name = document.getElementById(prefix + 'Name').value.trim();
            const area = document.getElementById(prefix + 'StrokesArea');
            area.innerHTML = '';
            
            if (!name) { updatePreview(prefix); return; }

            let html = '';
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                const info = getCharInfo(char);
                const strokeVal = info.strokes > 0 ? info.strokes : '';
                
                let tagClass = 'tag-unknown'; let tagText = 'æœªçŸ¥'; let inputClass = 'stroke-input';
                
                if (info.type === 'dual') { 
                    tagClass = 'tag-rainbow'; tagText = `çˆ­è­°(${info.strokes}æˆ–${info.alt})`; 
                    inputClass = 'stroke-input rainbow-flash text-white'; 
                }
                else if (info.type === 'ext') { tagClass = 'tag-ext'; tagText = 'é ‚ç´šåº«'; }
                else if (info.type === 'simp') { tagClass = 'tag-simp'; tagText = `ç°¡â†’${info.origin}`; }
                else if (info.type === 'trad') { tagClass = 'tag-trad'; tagText = 'å…§å»ºåº«'; }

                html += `
                    <div class="flex flex-col items-center">
                        <span class="text-lg text-white mb-1">${char}</span>
                        <input type="number" id="${prefix}S_val_${i}" class="${inputClass}" value="${strokeVal}" placeholder="?">
                        <span class="char-tag ${tagClass}">${tagText}</span>
                    </div>
                `;
            }
            area.innerHTML = html;
            updatePreview(prefix);
        }

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('stroke-input') || e.target.type === 'checkbox') {
                const prefix = e.target.id.startsWith('u') ? 'u' : 't';
                updatePreview(prefix);
            }
        });

        function updatePreview(prefix) {
            const inputs = document.querySelectorAll(`[id^="${prefix}S_val_"]`);
            if (inputs.length === 0) {
                ['Tian','Ren','Di','Wai','Zong'].forEach(k => document.getElementById(prefix + k).innerText = "?");
                document.getElementById(prefix + 'Polarity').innerHTML = '';
                return;
            }
            const strokes = Array.from(inputs).map(inp => parseInt(inp.value) || 0);
            
            const isDouble = document.getElementById(prefix + 'Double').checked;

            if (strokes.some(s => s === 0)) return;

            const sLen = isDouble ? 2 : 1;
            if (strokes.length < sLen) return;

            const surnameStrokes = strokes.slice(0, sLen); 
            const nameStrokes = strokes.slice(sLen);

            let heaven = surnameStrokes.length === 1 ? surnameStrokes[0] + 1 : surnameStrokes[0] + surnameStrokes[1];
            let person = surnameStrokes[surnameStrokes.length-1] + (nameStrokes[0] || 0);
            let earth = 0;
            if (nameStrokes.length === 0) {
                earth = 0;
            } else if (nameStrokes.length === 1) {
                earth = nameStrokes[0] + 1;
            } else {
                earth = nameStrokes.reduce((a,b)=>a+b, 0);
            }
            let total = strokes.reduce((a,b)=>a+b, 0);
            let outer = total - person;
            if (surnameStrokes.length === 1) outer += 1;
            if (nameStrokes.length === 1) outer += 1;

            document.getElementById(prefix + 'Tian').innerText = heaven;
            document.getElementById(prefix + 'Ren').innerText = person;
            document.getElementById(prefix + 'Di').innerText = earth;
            document.getElementById(prefix + 'Wai').innerText = outer;
            document.getElementById(prefix + 'Zong').innerText = total;

            // é™°é™½ç›¤åˆ¤å®š
            const grids = [heaven, person, earth, outer, total];
            const polarity = analyzePolarity(grids);
            const polarityEl = document.getElementById(prefix + 'Polarity');
            if (polarity === 'full_yang') {
                polarityEl.innerHTML = '<span class="text-red-400 font-bold">â˜€ï¸ å…¨é™½ç›¤ï¼šå€‹æ€§è±ªçˆ½ã€ç›´æ¥ã€åƒå“¥å€‘ã€å¥³ç”Ÿå¸¶ç”·ç›¸</span>';
            } else if (polarity === 'full_yin') {
                polarityEl.innerHTML = '<span class="text-blue-400 font-bold">ğŸŒ™ å…¨é™°ç›¤ï¼šå€‹æ€§æº«æŸ”ã€å„ªæŸ”å¯¡æ–·ã€å®¹æ˜“è®Šå¦</span>';
            } else {
                polarityEl.innerHTML = '';
            }
        }

        // ==========================================
        //  æ ¸å¿ƒæ¼”ç®—æ³•ï¼ˆä¾æ“šå§“åå­¸æ•¸ä½åŒ–3ï¼‰
        // ==========================================

        // 1. åŒ–æ°£å‡½å¼ (Reduce to single digit)
        function getHuaQi(number) {
            let sum = number;
            while (sum > 9) {
                let digits = sum.toString().split('').map(Number);
                sum = digits.reduce((a, b) => a + b, 0);
            }
            return sum;
        }

        // 2. é™°é™½ç›¤åˆ¤æ–·
        function analyzePolarity(grids) {
            let oddCount = 0;
            let evenCount = 0;
            grids.forEach(num => {
                if (num % 2 !== 0) oddCount++;
                else evenCount++;
            });
            if (oddCount === 5) return 'full_yang';
            if (evenCount === 5) return 'full_yin';
            return 'mixed';
        }

        // 3. é›™äººåˆç›¤å¼•æ“ (Cross Analysis)
        function analyzeRelationship(userA, userB) {
            let results = [];

            // --- A å° B çš„è²´äººæª¢æŸ¥ (çœ‹ Aäºº vs Båœ°) ---
            if (userA.ren === userB.di) {
                results.push({
                    type: 'noble_direct',
                    icon: 'ğŸ‘¼',
                    title: 'ç›´æ¥è²´äºº',
                    desc: `${userA.name} æ˜¯ ${userB.name} çš„<b>ç›´æ¥è²´äºº</b>`,
                    detail: `${userA.name} çš„äººæ ¼(${userA.ren}) = ${userB.name} çš„åœ°æ ¼(${userB.di})ï¼Œæœƒä¸»å‹•å¹«å¿™ã€ç›´æ¥çµ¦è³‡æºã€‚`,
                    strength: '1xï¼ˆç›´æ¥çµ¦è³‡æºï¼‰',
                    css: 'result-noble-direct'
                });
            } else if (getHuaQi(userA.ren) === getHuaQi(userB.di)) {
                results.push({
                    type: 'noble_indirect',
                    icon: 'âœ¨',
                    title: 'é–“æ¥è²´äºº',
                    desc: `${userA.name} æ˜¯ ${userB.name} çš„<b>é–“æ¥è²´äºº</b>`,
                    detail: `${userA.name} çš„äººæ ¼(${userA.ren})åŒ–æ°£${getHuaQi(userA.ren)} = ${userB.name} çš„åœ°æ ¼(${userB.di})åŒ–æ°£${getHuaQi(userB.di)}ï¼Œæœƒä»‹ç´¹è³‡æºï¼ŒåŠ›é‡æ›´å¼·å¤§ã€‚`,
                    strength: '10xï¼ˆè½‰ä»‹è³‡æºï¼ŒåŠ›é‡æ›´å¼·ï¼‰',
                    css: 'result-noble-indirect'
                });
            }

            // --- B å° A çš„è²´äººæª¢æŸ¥ (çœ‹ Bäºº vs Aåœ°) ---
            if (userB.ren === userA.di) {
                results.push({
                    type: 'noble_direct',
                    icon: 'ğŸ‘¼',
                    title: 'ç›´æ¥è²´äºº',
                    desc: `${userB.name} æ˜¯ ${userA.name} çš„<b>ç›´æ¥è²´äºº</b>`,
                    detail: `${userB.name} çš„äººæ ¼(${userB.ren}) = ${userA.name} çš„åœ°æ ¼(${userA.di})ï¼Œæœƒä¸»å‹•å¹«å¿™ã€ç›´æ¥çµ¦è³‡æºã€‚`,
                    strength: '1xï¼ˆç›´æ¥çµ¦è³‡æºï¼‰',
                    css: 'result-noble-direct'
                });
            } else if (getHuaQi(userB.ren) === getHuaQi(userA.di)) {
                results.push({
                    type: 'noble_indirect',
                    icon: 'âœ¨',
                    title: 'é–“æ¥è²´äºº',
                    desc: `${userB.name} æ˜¯ ${userA.name} çš„<b>é–“æ¥è²´äºº</b>`,
                    detail: `${userB.name} çš„äººæ ¼(${userB.ren})åŒ–æ°£${getHuaQi(userB.ren)} = ${userA.name} çš„åœ°æ ¼(${userA.di})åŒ–æ°£${getHuaQi(userA.di)}ï¼Œæœƒä»‹ç´¹è³‡æºï¼ŒåŠ›é‡æ›´å¼·å¤§ã€‚`,
                    strength: '10xï¼ˆè½‰ä»‹è³‡æºï¼ŒåŠ›é‡æ›´å¼·ï¼‰',
                    css: 'result-noble-indirect'
                });
            }

            // --- å°äººæª¢æŸ¥ (åœ°æ ¼ vs ç¸½æ ¼) ---
            // Case 1: Aåœ° vs Bç¸½ (è‹¥æˆç«‹ï¼ŒBæ‹–ç´¯A)
            if (userA.di === userB.zong) {
                results.push({
                    type: 'villain_direct',
                    icon: 'ğŸ’£',
                    title: 'æ˜å°äºº',
                    desc: `${userB.name} æ˜¯ ${userA.name} çš„<b>æ˜å°äºº</b>`,
                    detail: `${userA.name} çš„åœ°æ ¼(${userA.di}) = ${userB.name} çš„ç¸½æ ¼(${userB.zong})ï¼Œç›´æ¥è¡çªã€ä¸çµ¦é¢å­ã€æ‹–ç´¯ ${userA.name}ã€‚`,
                    strength: '1xï¼ˆç›´æ¥è¡çª/ä¸çµ¦é¢å­ï¼‰',
                    css: 'result-villain-direct'
                });
            } else if (getHuaQi(userA.di) === getHuaQi(userB.zong)) {
                results.push({
                    type: 'villain_indirect',
                    icon: 'ğŸ‘»',
                    title: 'æš—å°äºº',
                    desc: `${userB.name} æ˜¯ ${userA.name} çš„<b>æš—å°äºº</b>`,
                    detail: `${userA.name} çš„åœ°æ ¼(${userA.di})åŒ–æ°£${getHuaQi(userA.di)} = ${userB.name} çš„ç¸½æ ¼(${userB.zong})åŒ–æ°£${getHuaQi(userB.zong)}ï¼Œç„¡å¿ƒä¹‹éã€${userA.name} è¦å¹« ${userB.name} æ“¦å±è‚¡ã€‚`,
                    strength: '10xï¼ˆç„¡å¿ƒä¹‹é/éœ€å¹«å¿™æ“¦å±è‚¡ï¼‰',
                    css: 'result-villain-indirect'
                });
            }

            // Case 2: Båœ° vs Aç¸½ (è‹¥æˆç«‹ï¼ŒAæ‹–ç´¯B)
            if (userB.di === userA.zong) {
                results.push({
                    type: 'villain_direct',
                    icon: 'ğŸ’£',
                    title: 'æ˜å°äºº',
                    desc: `${userA.name} æ˜¯ ${userB.name} çš„<b>æ˜å°äºº</b>`,
                    detail: `${userB.name} çš„åœ°æ ¼(${userB.di}) = ${userA.name} çš„ç¸½æ ¼(${userA.zong})ï¼Œç›´æ¥è¡çªã€ä¸çµ¦é¢å­ã€æ‹–ç´¯ ${userB.name}ã€‚`,
                    strength: '1xï¼ˆç›´æ¥è¡çª/ä¸çµ¦é¢å­ï¼‰',
                    css: 'result-villain-direct'
                });
            } else if (getHuaQi(userB.di) === getHuaQi(userA.zong)) {
                results.push({
                    type: 'villain_indirect',
                    icon: 'ğŸ‘»',
                    title: 'æš—å°äºº',
                    desc: `${userA.name} æ˜¯ ${userB.name} çš„<b>æš—å°äºº</b>`,
                    detail: `${userB.name} çš„åœ°æ ¼(${userB.di})åŒ–æ°£${getHuaQi(userB.di)} = ${userA.name} çš„ç¸½æ ¼(${userA.zong})åŒ–æ°£${getHuaQi(userA.zong)}ï¼Œç„¡å¿ƒä¹‹éã€${userB.name} è¦å¹« ${userA.name} æ“¦å±è‚¡ã€‚`,
                    strength: '10xï¼ˆç„¡å¿ƒä¹‹é/éœ€å¹«å¿™æ“¦å±è‚¡ï¼‰',
                    css: 'result-villain-indirect'
                });
            }

            // --- å¹³å®®æª¢æŸ¥ (åŒæ ¼æ¯”è¼ƒ) ---
            if (userA.ren === userB.ren) {
                results.push({
                    type: 'equality',
                    icon: 'ğŸ¤',
                    title: 'äººæ ¼å¹³å®®',
                    desc: `å…©äºº<b>äººç”Ÿè§€/åƒ¹å€¼è§€ç›¸è¿‘</b>`,
                    detail: `${userA.name} çš„äººæ ¼(${userA.ren}) = ${userB.name} çš„äººæ ¼(${userB.ren})ï¼Œæƒ³æ³•ç›¸è¿‘ã€å®¹æ˜“æºé€šã€‚`,
                    strength: '',
                    css: 'result-equality'
                });
            }
            if (userA.di === userB.di) {
                results.push({
                    type: 'equality',
                    icon: 'ğŸ’•',
                    title: 'åœ°æ ¼å¹³å®®',
                    desc: `å…©äºº<b>æ„Ÿæƒ…è§€/äº‹æ¥­åšæ³•ç›¸è¿‘</b>`,
                    detail: `${userA.name} çš„åœ°æ ¼(${userA.di}) = ${userB.name} çš„åœ°æ ¼(${userB.di})ï¼Œæ„Ÿæƒ…è§€ä¸€è‡´ã€äº‹æ¥­åšæ³•ç›¸è¿‘ã€‚`,
                    strength: '',
                    css: 'result-equality'
                });
            }
            if (userA.zong === userB.zong) {
                results.push({
                    type: 'equality',
                    icon: 'ğŸ¯',
                    title: 'ç¸½æ ¼å¹³å®®',
                    desc: `å…©äºº<b>äººç”Ÿçµ‚æ¥µç›®æ¨™ä¸€è‡´</b>`,
                    detail: `${userA.name} çš„ç¸½æ ¼(${userA.zong}) = ${userB.name} çš„ç¸½æ ¼(${userB.zong})ï¼Œäººç”Ÿçµ‚æ¥µç›®æ¨™ä¸€è‡´ã€‚`,
                    strength: '',
                    css: 'result-equality'
                });
            }

            return results;
        }

        // ==========================================
        //  ä¸»è¨ˆç®—å‡½å¼
        // ==========================================
        function calculateAndScan() {
            updatePreview('u'); updatePreview('t');
            
            const uName = document.getElementById('uName').value.trim();
            const tName = document.getElementById('tName').value.trim();

            const uRen = parseInt(document.getElementById('uRen').innerText);
            const tRen = parseInt(document.getElementById('tRen').innerText);
            
            if (isNaN(uRen) || isNaN(tRen)) { alert("è«‹ç¢ºä¿æ‰€æœ‰ç­†åŠƒéƒ½å·²è¼¸å…¥æ­£ç¢ºå–”ï¼"); return; }

            const uTian = parseInt(document.getElementById('uTian').innerText);
            const uDi = parseInt(document.getElementById('uDi').innerText);
            const uZong = parseInt(document.getElementById('uZong').innerText);
            const uWai = parseInt(document.getElementById('uWai').innerText);
            
            const tTian = parseInt(document.getElementById('tTian').innerText);
            const tDi = parseInt(document.getElementById('tDi').innerText);
            const tZong = parseInt(document.getElementById('tZong').innerText);
            const tWai = parseInt(document.getElementById('tWai').innerText);

            const userA = { name: uName || 'A', tian: uTian, ren: uRen, di: uDi, wai: uWai, zong: uZong };
            const userB = { name: tName || 'B', tian: tTian, ren: tRen, di: tDi, wai: tWai, zong: tZong };

            // åŸ·è¡Œåˆç›¤åˆ†æ
            const results = analyzeRelationship(userA, userB);

            // é™°é™½ç›¤åˆ†æ
            const uPol = analyzePolarity([uTian, uRen, uDi, uWai, uZong]);
            const tPol = analyzePolarity([tTian, tRen, tDi, tWai, tZong]);

            // æ¸²æŸ“çµæœ
            const area = document.getElementById('resultArea');
            let html = '<div id="captureTarget" class="bg-[#111827] p-4 rounded-2xl">';
            
            // æ¨™é¡Œ
            html += `<div class="text-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-600">åˆç›¤é‘‘å®šå ±å‘Š</h2>
                <p class="text-gray-400 text-sm mt-1">${userA.name} â†” ${userB.name}</p>
            </div>`;

            // äº”æ ¼å°ç…§è¡¨
            html += `<div class="glass p-4 mb-4">
                <table class="w-full text-center text-sm">
                    <tr class="text-gray-400">
                        <th class="pb-2"></th><th class="pb-2">å¤©æ ¼</th><th class="pb-2">äººæ ¼</th><th class="pb-2">åœ°æ ¼</th><th class="pb-2">å¤–æ ¼</th><th class="pb-2">ç¸½æ ¼</th>
                    </tr>
                    <tr class="text-yellow-400 font-bold">
                        <td class="py-1">${userA.name}</td><td>${uTian}</td><td>${uRen}</td><td>${uDi}</td><td>${uWai}</td><td>${uZong}</td>
                    </tr>
                    <tr class="text-blue-400 font-bold">
                        <td class="py-1">${userB.name}</td><td>${tTian}</td><td>${tRen}</td><td>${tDi}</td><td>${tWai}</td><td>${tZong}</td>
                    </tr>
                </table>
            </div>`;

            // é™°é™½ç›¤é¡¯ç¤º
            if (uPol !== 'mixed' || tPol !== 'mixed') {
                html += '<div class="result-card result-polarity mb-4">';
                html += '<div class="text-center font-bold text-emerald-400 mb-2">ğŸ”® é™°é™½ç›¤å±¬æ€§</div>';
                if (uPol === 'full_yang') html += `<div class="text-sm text-gray-200 mb-1">â˜€ï¸ ${userA.name}ï¼š<b class="text-red-400">å…¨é™½ç›¤</b> â€” å€‹æ€§è±ªçˆ½ã€ç›´æ¥ã€åƒå“¥å€‘ã€å¥³ç”Ÿå¸¶ç”·ç›¸</div>`;
                if (uPol === 'full_yin') html += `<div class="text-sm text-gray-200 mb-1">ğŸŒ™ ${userA.name}ï¼š<b class="text-blue-400">å…¨é™°ç›¤</b> â€” å€‹æ€§æº«æŸ”ã€å„ªæŸ”å¯¡æ–·ã€å®¹æ˜“è®Šå¦</div>`;
                if (tPol === 'full_yang') html += `<div class="text-sm text-gray-200 mb-1">â˜€ï¸ ${userB.name}ï¼š<b class="text-red-400">å…¨é™½ç›¤</b> â€” å€‹æ€§è±ªçˆ½ã€ç›´æ¥ã€åƒå“¥å€‘ã€å¥³ç”Ÿå¸¶ç”·ç›¸</div>`;
                if (tPol === 'full_yin') html += `<div class="text-sm text-gray-200 mb-1">ğŸŒ™ ${userB.name}ï¼š<b class="text-blue-400">å…¨é™°ç›¤</b> â€” å€‹æ€§æº«æŸ”ã€å„ªæŸ”å¯¡æ–·ã€å®¹æ˜“è®Šå¦</div>`;
                html += '</div>';
            }

            // é—œä¿‚çµæœå¡ç‰‡
            if (results.length > 0) {
                results.forEach(r => {
                    html += `<div class="result-card ${r.css}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${r.icon}</span>
                            <span class="font-bold text-lg text-white">${r.title}</span>
                            ${r.strength ? `<span class="text-xs text-gray-400 ml-auto">${r.strength}</span>` : ''}
                        </div>
                        <div class="text-gray-200 text-sm mb-1">${r.desc}</div>
                        <div class="text-gray-400 text-xs">${r.detail}</div>
                    </div>`;
                });
            } else {
                html += `<div class="result-card result-none text-center">
                    <div class="text-4xl mb-2">ğŸµ</div>
                    <div class="font-bold text-lg text-white mb-1">æ³›æ³›ä¹‹äº¤</div>
                    <div class="text-gray-400 text-sm">å…©äººä¹‹é–“ç„¡æ˜é¡¯è²´äººã€å°äººæˆ–å¹³å®®é—œä¿‚ï¼Œç·£åˆ†å¹³æ·¡ã€‚</div>
                </div>`;
            }

            // æ°´å°
            html += `<div class="mt-4 text-center text-[10px] text-gray-500 opacity-50">@æ‰¾å°çš„äºº App V7.0 â€” å§“ååˆç›¤åˆ†æ | ä¾†æºï¼šå§“åå­¸æ•¸ä½åŒ–ç¬¬ä¸‰å ‚</div>`;
            html += '</div>';

            // åˆ†äº«æŒ‰éˆ•
            html += `<button onclick="shareResult()" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl text-lg shadow-lg flex justify-center items-center gap-2 transition-all">
                <span>ğŸ“¸</span> å„²å­˜çµæœåœ–ç‰‡åˆ†äº«çµ¦æœ‹å‹
            </button>`;

            area.innerHTML = html;
            area.classList.remove('hidden');
        }

        // --- æˆªåœ–åˆ†äº«åŠŸèƒ½ ---
        function shareResult() {
            const captureTarget = document.getElementById('captureTarget');
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = "<span>â³</span> æ­£åœ¨ç”¢ç”Ÿç²¾ç¾åœ–å¡...";
            btn.disabled = true;

            html2canvas(captureTarget, {
                backgroundColor: "#111827",
                scale: 2
            }).then(canvas => {
                const imgUrl = canvas.toDataURL("image/png");
                const downloadLink = document.createElement("a");
                downloadLink.href = imgUrl;
                downloadLink.download = "æ‰¾å°çš„äºº_åˆç›¤å ±å‘Š.png";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                btn.innerHTML = "<span>âœ…</span> åœ–ç‰‡å·²å„²å­˜ï¼å¿«å» LINE åˆ†äº«å§";
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }).catch(err => {
                console.error("æˆªåœ–å¤±æ•—:", err);
                alert("ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—ï¼Œè«‹ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿæˆªåœ–åŠŸèƒ½ã€‚");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // --- å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ 8.1 è¬å­—åº« ---
        (function autoLoadKangxiDB() {
            const btnText = document.getElementById('btnText');
            const importBtn = document.getElementById('importBtn');
            const dbCount = document.getElementById('dbCount');
            
            btnText.innerText = 'è¼‰å…¥ä¸­...';
            importBtn.classList.add('loading-pulse');
            
            fetch('kangxi_db.json')
                .then(resp => {
                    if (!resp.ok) throw new Error('å­—åº«æª”æ¡ˆä¸å­˜åœ¨');
                    return resp.json();
                })
                .then(json => {
                    let loadedCount = 0;
                    for (let ch in json) {
                        externalDB[ch] = json[ch];
                        loadedCount++;
                    }
                    if (loadedCount > 0) {
                        dbLoaded = true;
                        const countStr = loadedCount > 10000 ? (loadedCount/10000).toFixed(1) + 'è¬' : loadedCount;
                        dbCount.innerText = 'æ»¿è¡€ç‰ˆ: ' + countStr + 'å­—';
                        dbCount.classList.add('text-purple-400');
                        btnText.innerText = '8.1è¬å­—åº«å·²è¼‰å…¥';
                        importBtn.classList.remove('bg-purple-600', 'loading-pulse');
                        importBtn.classList.add('bg-green-600');
                        console.log('âœ… åº·ç†™å­—å…¸å­—åº«è‡ªå‹•è¼‰å…¥å®Œæˆ: ' + loadedCount + ' å­—');
                    }
                })
                .catch(err => {
                    console.log('â„¹ï¸ æœªæ‰¾åˆ°å…§å»ºå­—åº«ï¼Œå¯æ‰‹å‹•åŒ¯å…¥: ' + err.message);
                    btnText.innerText = 'åŒ¯å…¥8è¬å­—åº«';
                    importBtn.classList.remove('loading-pulse');
                });
        })();
    </script>
</body>
</html>
