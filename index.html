<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰¾å°çš„äºº (V6.3 ç¤¾ç¾¤åˆ†äº«ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ html2canvas å‡½å¼åº«ï¼Œç”¨æ–¼å°‡çµæœè½‰æ›ç‚ºåœ–ç‰‡ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #111827; color: white; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .stroke-input { width: 40px; text-align: center; background: rgba(0,0,0,0.6); color: #fbbf24; border: 1px solid #4b5563; border-radius: 6px; font-weight: bold; }
        .char-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: inline-block; }
        .tag-simp { background: #ef4444; color: white; }
        .tag-trad { background: #10b981; color: white; }
        .tag-ext { background: #8b5cf6; color: white; box-shadow: 0 0 8px #8b5cf6; } 
        .tag-unknown { background: #6b7280; color: white; }
        
        /* æª”æ¡ˆä¸Šå‚³éš±è— */
        #fileInput { display: none; }
        .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* çˆ­è­°å­—å½©è™¹é–ƒçˆç‰¹æ•ˆ */
        .tag-rainbow { 
            background: linear-gradient(90deg, #ff0000, #ff7f00, #00b300, #0000ff, #8b00ff, #ff0000);
            background-size: 200% 200%;
            animation: rainbowBg 2s linear infinite;
            color: white; 
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
        }
        .rainbow-flash { animation: rainbowBorder 1.5s linear infinite; }
        @keyframes rainbowBg { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
        @keyframes rainbowBorder {
            0% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
            16% { border-color: #ff7f00; box-shadow: 0 0 10px #ff7f00; }
            33% { border-color: #ffff00; box-shadow: 0 0 10px #ffff00; }
            50% { border-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
            66% { border-color: #0000ff; box-shadow: 0 0 10px #0000ff; }
            83% { border-color: #8b00ff; box-shadow: 0 0 10px #8b00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <header class="w-full max-w-md flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-600 tracking-wider">æ‰¾å°çš„äºº</h1>
            <div class="text-xs text-purple-400 font-bold tracking-widest mt-1">V6.3 ç¤¾ç¾¤åˆ†äº«ç‰ˆ</div>
        </div>
        <div class="flex items-center gap-2">
            <span id="dbCount" class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 font-mono">å…§å»º: 6000å­—</span>
            <button onclick="document.getElementById('fileInput').click()" id="importBtn" class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1.5 rounded-lg shadow-lg transition flex items-center gap-1">
                <span>ğŸ“‚</span> <span id="btnText">åŒ¯å…¥8è¬å­—åº«</span>
            </button>
            <input type="file" id="fileInput" accept=".json" onchange="loadExternalDB(this)">
        </div>
    </header>

    <!-- 1. æˆ‘æ˜¯èª° (User) -->
    <div class="glass w-full max-w-md p-5 mb-4 relative border-l-4 border-yellow-500">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-yellow-400 text-lg flex items-center">ğŸ˜ æˆ‘æ˜¯èª° (User)</h3>
            <label class="text-xs text-gray-300 flex items-center cursor-pointer select-none" title="è‹¥ç‚ºæ­é™½ã€å¸é¦¬ç­‰è¤‡å§“è«‹å‹¾é¸">
                <input type="checkbox" id="uDouble" class="mr-1 w-4 h-4 accent-yellow-500 rounded"> è¤‡å§“ (å‰å…©å­—ç‚ºå§“)
            </label>
        </div>
        <div class="relative mb-4">
            <input type="text" id="uName" placeholder="æ¸¬è©¦è¼¸å…¥ï¼šæ­é™½è²è² æˆ– è•­è‚²æ²›" 
                   class="w-full p-3 rounded-xl bg-gray-900/50 border border-gray-600 text-white font-bold text-center text-xl focus:border-yellow-500 focus:outline-none transition-colors"
                   oninput="autoDetect('u')">
        </div>
        
        <!-- å‹•æ…‹ç­†åŠƒå€ -->
        <div class="bg-gray-900/40 p-3 rounded-xl">
            <div class="flex justify-center gap-3 flex-wrap" id="uStrokesArea"></div>
        </div>
        
        <!-- äº”æ ¼é è¦½ -->
        <div class="mt-3 flex justify-between text-sm text-gray-300 px-2">
            <div>å¤©<span id="uTian" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>äºº<span id="uRen" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>åœ°<span id="uDi" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>å¤–<span id="uWai" class="text-yellow-400 font-bold ml-1">?</span></div>
            <div>ç¸½<span id="uZong" class="text-yellow-400 font-bold ml-1">?</span></div>
        </div>
    </div>

    <!-- 2. å°æ–¹æ˜¯ (Target) -->
    <div class="glass w-full max-w-md p-5 mb-8 relative border-l-4 border-blue-500">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-blue-400 text-lg flex items-center">ğŸ¯ å°æ–¹æ˜¯ (Target)</h3>
            <label class="text-xs text-gray-300 flex items-center cursor-pointer select-none" title="è‹¥ç‚ºæ­é™½ã€å¸é¦¬ç­‰è¤‡å§“è«‹å‹¾é¸">
                <input type="checkbox" id="tDouble" class="mr-1 w-4 h-4 accent-blue-500 rounded"> è¤‡å§“ (å‰å…©å­—ç‚ºå§“)
            </label>
        </div>
        <div class="relative mb-4">
            <input type="text" id="tName" placeholder="è¼¸å…¥å§“å (æ”¯æ´ç°¡ç¹)" 
                   class="w-full p-3 rounded-xl bg-gray-900/50 border border-gray-600 text-white font-bold text-center text-xl focus:border-blue-500 focus:outline-none transition-colors"
                   oninput="autoDetect('t')">
        </div>

        <div class="bg-gray-900/40 p-3 rounded-xl">
            <div class="flex justify-center gap-3 flex-wrap" id="tStrokesArea"></div>
        </div>

        <!-- äº”æ ¼é è¦½ -->
        <div class="mt-3 flex justify-between text-sm text-gray-300 px-2">
            <div>å¤©<span id="tTian" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>äºº<span id="tRen" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>åœ°<span id="tDi" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>å¤–<span id="tWai" class="text-blue-400 font-bold ml-1">?</span></div>
            <div>ç¸½<span id="tZong" class="text-blue-400 font-bold ml-1">?</span></div>
        </div>
    </div>

    <!-- æŒ‰éˆ• -->
    <button onclick="calculateAndScan()" class="w-full max-w-md bg-gradient-to-r from-yellow-600 via-orange-600 to-red-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:shadow-yellow-500/20 active:scale-95 transition-all mb-8 flex justify-center items-center gap-2">
        <span>ğŸ”</span> å•Ÿå‹•ç²¾æº–é‘‘å®š
    </button>

    <!-- çµæœå€ -->
    <div id="resultArea" class="hidden w-full max-w-md animate-fade-in-up"></div>
    
    <!-- éš±è—çš„åˆ†äº«ç”¨ç•«å¸ƒ (Canvas) -->
    <div id="shareCanvasArea" class="hidden"></div>

    <script>
        // ==========================================
        //  è³‡æ–™åº«ç³»çµ±
        // ==========================================
        let externalDB = {}; 

        // æ ¸å¿ƒå­—åº« (é è¨­ 6000 å­—ç²¾ç°¡ç‰ˆæ¼”ç¤º)
        const coreDB = {
            'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10,
            'é™³':16, 'æ—':8, 'é»ƒ':12, 'å¼µ':11, 'æ':7, 'ç‹':4, 'å³':7, 'åŠ‰':15, 'è”¡':17, 'æ¥Š':13,
            'è¨±':11, 'é„­':19, 'éƒ­':15, 'æ´ª':10, 'æ›¾':12, 'é‚±':12, 'å»–':14, 'å¾':10,
            'å¤§':3, 'å°':3, 'å¤©':4, 'æ–‡':4, 'æ­£':5, 'æ°¸':5, 'å¿—':7, 'å®':7, 'å›':7, 'æ˜':8,
            'æ€¡':9, 'ä¿Š':9, 'å»º':9, 'ç¾':9, 'å®¶':10, 'æ·‘':12, 'å©·':12, 'è¯':14, 'è±ª':14, 'éŠ˜':14,
            'æ­':15, 'é™½':17, 'å¸':5, 'é¦¬':10, 'è«¸':16, 'è‘›':15, 'è²':14, 'ç‚':8, 'ç›¸':9, 'å¦‚':6,
            'ç‹':5, 'ç‰':5, 'æ°µ':4, 'æ°´':4, 'å¿„':4, 'å¿ƒ':4, 'æ‰Œ':4, 'æ‰‹':4, 'è‰¹':6, 'è‰¸':6, 
            'æœˆ':6, 'è‚‰':6, 'è¾¶':7, 'è¾µ':7, 'é˜':8 
        };

        // ç°¡é«”å­—åº«
        const simpMap = {
            'é™ˆ': [16, 'é™³'], 'å¼ ': [11, 'å¼µ'], 'åˆ˜': [15, 'åŠ‰'], 'é»„': [12, 'é»ƒ'], 'æ¨': [13, 'æ¥Š'],
            'èµµ': [14, 'è¶™'], 'å‘¨': [8, 'å‘¨'], 'å´': [7, 'å³'], 'å¾': [10, 'å¾'], 'å­™': [10, 'å­«'],
            'é©¬': [10, 'é¦¬'], 'æœ±': [6, 'æœ±'], 'èƒ¡': [11, 'èƒ¡'], 'éƒ­': [15, 'éƒ­'], 'æ—': [8, 'æ—'],
            'é¾™': [16, 'é¾'], 'å': [14, 'è¯'], 'å›½': [11, 'åœ‹'], 'å¼º': [11, 'å¼·'], 'ä¼Ÿ': [11, 'å‰']
        };

        // çˆ­è­°å­—åº« (å„ªå…ˆæ””æˆª + å½©è™¹ç‰¹æ•ˆ)
        const dualStrokesMap = {
            'è‚²': [9, 10], 'å‰': [5, 6], 'å¦': [8, 9], 'å±': [10, 11],
            'æ¯“': [13, 14], 'æ²›': [8, 9], 'æ…ˆ': [13, 14], 'è•­': [18, 19]
        };

        // --- æª”æ¡ˆè¼‰å…¥é‚è¼¯ (æ”¯æ´ 8.1 è¬å­— kangxi_complete.json) ---
        function loadExternalDB(input) {
            const file = input.files[0];
            if (!file) return;

            const btnText = document.getElementById('btnText');
            const originalText = btnText.innerText;
            btnText.innerText = "è§£æä¸­...";
            document.getElementById('importBtn').classList.add('loading-pulse');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    let loadedCount = 0;
                    externalDB = {}; 
                    
                    let dataArray = null;
                    if (Array.isArray(json)) dataArray = json;
                    else if (json.data && Array.isArray(json.data)) dataArray = json.data;
                    else if (json.characters && Array.isArray(json.characters)) dataArray = json.characters;
                    else {
                        for (let key in json) {
                            if (Array.isArray(json[key]) && json[key].length > 1000) {
                                dataArray = json[key]; break;
                            }
                        }
                    }

                    if (dataArray) {
                        dataArray.forEach(item => {
                            if (item.character && item.strokes !== undefined) {
                                externalDB[item.character] = parseInt(item.strokes);
                                loadedCount++;
                            }
                        });
                    }

                    if (loadedCount > 0) {
                        const countStr = loadedCount > 10000 ? (loadedCount/10000).toFixed(1) + "è¬" : loadedCount;
                        document.getElementById('dbCount').innerText = `æ»¿è¡€ç‰ˆ: ${countStr}å­—`;
                        document.getElementById('dbCount').classList.add('text-purple-400');
                        btnText.innerText = "å­—åº«å·²è¼‰å…¥";
                        document.getElementById('importBtn').classList.remove('bg-purple-600', 'loading-pulse');
                        document.getElementById('importBtn').classList.add('bg-green-600');
                        
                        autoDetect('u'); autoDetect('t');
                        alert(`âœ… è®€å–æˆåŠŸï¼å·²å°‡ ${loadedCount.toLocaleString()} å€‹åº·ç†™å­—å…¸è³‡æ–™åŒ¯å…¥è¨˜æ†¶é«”ã€‚`);
                    } else {
                        throw new Error("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„æ–‡å­—èˆ‡ç­†åŠƒé™£åˆ—");
                    }
                } catch (err) {
                    btnText.innerText = originalText;
                    document.getElementById('importBtn').classList.remove('loading-pulse');
                    alert("âŒ è®€å–å¤±æ•—: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- æŸ¥è©¢é‚è¼¯ ---
        function getCharInfo(char) {
            if (dualStrokesMap[char]) return { strokes: dualStrokesMap[char][0], origin: char, type: 'dual', alt: dualStrokesMap[char][1] };
            if (externalDB[char]) return { strokes: externalDB[char], origin: char, type: 'ext' };
            if (simpMap[char]) return { strokes: simpMap[char][0], origin: simpMap[char][1], type: 'simp' };
            if (coreDB[char]) return { strokes: coreDB[char], origin: char, type: 'trad' };
            return { strokes: 0, origin: char, type: 'unknown' };
        }

        // --- UI é‹ç®—èˆ‡æ¸²æŸ“ ---
        function autoDetect(prefix) {
            const name = document.getElementById(prefix + 'Name').value.trim();
            const area = document.getElementById(prefix + 'StrokesArea');
            area.innerHTML = '';
            
            if (!name) { updatePreview(prefix); return; }

            let html = '';
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                const info = getCharInfo(char);
                const strokeVal = info.strokes > 0 ? info.strokes : '';
                
                let tagClass = 'tag-unknown'; let tagText = 'æœªçŸ¥'; let inputClass = 'stroke-input';
                
                if (info.type === 'dual') { 
                    tagClass = 'tag-rainbow'; tagText = `çˆ­è­°(${info.strokes}æˆ–${info.alt})`; 
                    inputClass = 'stroke-input rainbow-flash text-white'; 
                }
                else if (info.type === 'ext') { tagClass = 'tag-ext'; tagText = 'é ‚ç´šåº«'; }
                else if (info.type === 'simp') { tagClass = 'tag-simp'; tagText = `ç°¡â†’${info.origin}`; }
                else if (info.type === 'trad') { tagClass = 'tag-trad'; tagText = 'å…§å»ºåº«'; }

                html += `
                    <div class="flex flex-col items-center">
                        <span class="text-lg text-white mb-1">${char}</span>
                        <input type="number" id="${prefix}S_val_${i}" class="${inputClass}" value="${strokeVal}" placeholder="?">
                        <span class="char-tag ${tagClass}">${tagText}</span>
                    </div>
                `;
            }
            area.innerHTML = html;
            updatePreview(prefix);
        }

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('stroke-input') || e.target.type === 'checkbox') {
                const prefix = e.target.id.startsWith('u') ? 'u' : 't';
                updatePreview(prefix);
            }
        });

        function updatePreview(prefix) {
            const inputs = document.querySelectorAll(`[id^="${prefix}S_val_"]`);
            if (inputs.length === 0) {
                ['Tian','Ren','Di','Wai','Zong'].forEach(k => document.getElementById(prefix + k).innerText = "?");
                return;
            }
            const strokes = Array.from(inputs).map(inp => parseInt(inp.value) || 0);
            
            // ç¢ºèªæ˜¯å¦å‹¾é¸ç‚ºè¤‡å§“
            const isDouble = document.getElementById(prefix + 'Double').checked;

            if (strokes.some(s => s === 0)) return;

            // å‹•æ…‹é™£åˆ—åˆ‡å‰²ï¼šä¾æ“šæ˜¯å¦ç‚ºè¤‡å§“ï¼Œæ±ºå®šå§“æ°çš„å­—æ•¸
            const sLen = isDouble ? 2 : 1;
            if (strokes.length < sLen) return; // å­—æ•¸ä¸è¶³ä»¥æ§‹æˆè¤‡å§“

            const surnameStrokes = strokes.slice(0, sLen); 
            const nameStrokes = strokes.slice(sLen);

            // å¤©æ ¼ï¼šå–®å§“åŠ 1ï¼Œè¤‡å§“ç›¸åŠ 
            let heaven = surnameStrokes.length === 1 ? surnameStrokes[0] + 1 : surnameStrokes[0] + surnameStrokes[1];
            
            // äººæ ¼ï¼šå§“æ°æœ€å¾Œä¸€å­— + åå­—ç¬¬ä¸€å­—
            let person = surnameStrokes[surnameStrokes.length-1] + (nameStrokes[0] || 0);
            
            // åœ°æ ¼ï¼šå–®ååŠ 1ï¼Œè¤‡åç›¸åŠ 
            let earth = 0;
            if (nameStrokes.length === 0) {
                earth = 0;
            } else if (nameStrokes.length === 1) {
                earth = nameStrokes[0] + 1; // ç³»çµ±è‡ªå‹•åˆ¤æ–·å–®åä¸¦ +1
            } else {
                earth = nameStrokes.reduce((a,b)=>a+b, 0);
            }

            // ç¸½æ ¼ï¼šå…¨éƒ¨ç›¸åŠ 
            let total = strokes.reduce((a,b)=>a+b, 0);
            
            // è¬ç”¨å¤–æ ¼å…¬å¼ï¼šç¸½æ ¼ - äººæ ¼ + (å–®å§“è£œ1) + (å–®åè£œ1)
            let outer = total - person;
            if (surnameStrokes.length === 1) outer += 1;
            if (nameStrokes.length === 1) outer += 1;

            document.getElementById(prefix + 'Tian').innerText = heaven;
            document.getElementById(prefix + 'Ren').innerText = person;
            document.getElementById(prefix + 'Di').innerText = earth;
            document.getElementById(prefix + 'Wai').innerText = outer;
            document.getElementById(prefix + 'Zong').innerText = total;
        }

        function reduce(num) {
            if (num === 0) return 0;
            while (num > 9) { num = num.toString().split('').reduce((a,b)=>parseInt(a)+parseInt(b), 0); }
            return num;
        }

        function calculateAndScan() {
            updatePreview('u'); updatePreview('t');
            
            const uRen = parseInt(document.getElementById('uRen').innerText);
            const tRen = parseInt(document.getElementById('tRen').innerText);
            
            if (isNaN(uRen) || isNaN(tRen)) { alert("è«‹ç¢ºä¿æ‰€æœ‰ç­†åŠƒéƒ½å·²è¼¸å…¥æ­£ç¢ºå–”ï¼"); return; }

            const uDi = parseInt(document.getElementById('uDi').innerText);
            const uZong = parseInt(document.getElementById('uZong').innerText);
            const uWai = parseInt(document.getElementById('uWai').innerText);
            
            const tDi = parseInt(document.getElementById('tDi').innerText);
            const tZong = parseInt(document.getElementById('tZong').innerText);
            const tWai = parseInt(document.getElementById('tWai').innerText);

            const uRenH = reduce(uRen); const uDiH = reduce(uDi); const uZongH = reduce(uZong);
            const tRenH = reduce(tRen); const tDiH = reduce(tDi); const tZongH = reduce(tZong);

            let res = { type: 'normal', title: 'æ³›æ³›ä¹‹äº¤', icon: 'ğŸµ', color: 'border-gray-500 bg-gray-800', desc: 'ç·£åˆ†å¹³æ·¡ï¼Œç„¡æ˜é¡¯ç”Ÿå‰‹ã€‚' };

            if (tRen === uDi) { res = { type: 'noble', title: 'å°æ–¹æ˜¯å°çš„äºº (è²´äºº)', icon: 'ğŸ‘¼', color: 'border-yellow-500 bg-yellow-900', desc: `æ­å–œï¼é€™æ˜¯å°çš„äººã€‚å°æ–¹çš„æ€æƒ³(äººæ ¼${tRen})ç›´æ¥æ‹‰æ‹”ä½ çš„åŸºç¤(åœ°æ ¼${uDi})ï¼Œæ˜¯ä¾†æˆå°±ä½ çš„ã€‚` }; }
            else if (uRen === tDi) { res = { type: 'noble', title: 'ä½ æ˜¯å°æ–¹çš„è²´äºº', icon: 'ğŸ¤', color: 'border-yellow-500 bg-yellow-900', desc: `ä½ çš„æ ¼å±€(äººæ ¼${uRen})åœ¨å°æ–¹ä¹‹ä¸Šï¼Œä½ æœƒæƒ³å¹«ä»–ã€‚é€™æ˜¯ä¸€æ®µè‰¯å–„çš„ç·£åˆ†ã€‚` }; }
            else if (tZong === uDi) { res = { type: 'villain', title: 'é€™ä¸æ˜¯å°çš„äºº (å°äºº)', icon: 'ğŸ’£', color: 'border-red-500 bg-red-900', desc: `è­¦å ±ï¼é€™å¯èƒ½ä¸æ˜¯å°çš„äººã€‚å°æ–¹çš„çµæœ(ç¸½æ ¼${tZong})æœƒæ‹–ç´¯ä½ çš„åŸºç¤(åœ°æ ¼${uDi})ã€‚` }; }
            else if (uZong === tDi) { res = { type: 'villain', title: 'ç›¸è™•éœ€è¬¹æ… (å°äºº)', icon: 'âš ï¸', color: 'border-red-500 bg-red-900', desc: `ä½ å€‘æ°£å ´ç›¸å‰‹ï¼Œä½ å¯èƒ½æœƒç„¡æ„é–“æ‹–ç´¯ä»–ã€‚å½¼æ­¤ç›¸è™•æœƒæ¯”è¼ƒè¾›è‹¦ã€‚` }; }
            else if (tRenH === uDiH) { res = { type: 'indirect_noble', title: 'æ½›åœ¨çš„å°çš„äºº', icon: 'âœ¨', color: 'border-purple-500 bg-purple-900', desc: 'é›–ç„¶æ•¸å­—ä¸åŒï¼Œä½†åŒ–æ°£ç›¸åŒã€‚æ˜¯æ½›åŠ›è‚¡ï¼Œæœƒæš—ä¸­çµ¦ä½ è³‡æºã€‚' }; }
            else if (uRenH === tDiH) { res = { type: 'indirect_noble', title: 'ä½ æ˜¯æ½›åœ¨è²´äºº', icon: 'âœ¨', color: 'border-purple-500 bg-purple-900', desc: 'åŒ–æ°£ç›¸åŒï¼Œä½ æœƒåœ¨ä¸çŸ¥ä¸è¦ºä¸­å¹«åŠ©åˆ°ä»–ã€‚' }; }
            else if (tZongH === uDiH || uZongH === tDiH) { res = { type: 'indirect_villain', title: 'éš±æ€§è² æ“”', icon: 'ğŸ‘»', color: 'border-gray-500 bg-gray-700', desc: 'é€™æ®µé—œä¿‚å¯èƒ½æ¯”è¼ƒç´¯ï¼Œæˆäº‹ä¸è¶³æ•—äº‹æœ‰é¤˜ï¼Œå®¹æ˜“äº’ç›¸å¹²æ“¾ã€‚' }; }

            const area = document.getElementById('resultArea');
            // æ³¨æ„ï¼šé€™è£¡æˆ‘åŠ å…¥äº†ä¸€å€‹ id="captureTarget" ä»¥åŠåˆ†äº«æŒ‰éˆ•
            area.innerHTML = `
                <div id="captureTarget" class="glass p-6 text-center border-t-8 ${res.color} shadow-2xl transform transition-all hover:scale-105 bg-[#111827]">
                    <div class="text-7xl mb-4 filter drop-shadow-lg animate-bounce">${res.icon}</div>
                    <h2 class="text-3xl font-bold mb-2 text-white">${res.title}</h2>
                    <p class="text-gray-200 text-lg leading-relaxed">${res.desc}</p>
                    <div class="mt-6 pt-4 border-t border-gray-600 text-xs text-gray-400 font-mono">
                        ç³»çµ±åˆ¤å®š: User[äºº${uRen}/åœ°${uDi}/å¤–${uWai}/ç¸½${uZong}] vs Target[äºº${tRen}/åœ°${tDi}/å¤–${tWai}/ç¸½${tZong}]
                    </div>
                    <!-- æ°´å° -->
                    <div class="mt-2 text-[10px] text-gray-500 opacity-50">@æ‰¾å°çš„äºº App - ç²¾æº–å§“åå­¸åˆ†æ</div>
                </div>
                
                <button onclick="shareResult()" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl text-lg shadow-lg flex justify-center items-center gap-2 transition-all">
                    <span>ğŸ“¸</span> å„²å­˜çµæœåœ–ç‰‡åˆ†äº«çµ¦æœ‹å‹
                </button>
            `;
            area.classList.remove('hidden');
        }

        // --- æ–°å¢ï¼šæˆªåœ–åˆ†äº«åŠŸèƒ½ ---
        function shareResult() {
            const captureTarget = document.getElementById('captureTarget');
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = "<span>â³</span> æ­£åœ¨ç”¢ç”Ÿç²¾ç¾åœ–å¡...";
            btn.disabled = true;

            // ä½¿ç”¨ html2canvas å°‡æŒ‡å®šçš„ div è½‰æˆ canvas
            html2canvas(captureTarget, {
                backgroundColor: "#111827", // ä¿æŒæ·±è‰²èƒŒæ™¯
                scale: 2 // æé«˜æˆªåœ–ç•«è³ª
            }).then(canvas => {
                // å°‡ canvas è½‰ç‚ºåœ–ç‰‡ URL
                const imgUrl = canvas.toDataURL("image/png");
                
                // å»ºç«‹ä¸€å€‹éš±è—çš„ä¸‹è¼‰é€£çµä¸¦è§¸ç™¼é»æ“Š
                const downloadLink = document.createElement("a");
                downloadLink.href = imgUrl;
                downloadLink.download = "æ‰¾å°çš„äºº_é‘‘å®šå ±å‘Š.png"; // ä¸‹è¼‰çš„æª”å
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                btn.innerHTML = "<span>âœ…</span> åœ–ç‰‡å·²å„²å­˜ï¼å¿«å» LINE åˆ†äº«å§";
                
                // 3ç§’å¾Œæ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }).catch(err => {
                console.error("æˆªåœ–å¤±æ•—:", err);
                alert("ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—ï¼Œè«‹ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿæˆªåœ–åŠŸèƒ½ã€‚");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>